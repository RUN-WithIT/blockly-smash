Blockly.Blocks.blaster={init:function(){this.appendDummyInput().appendField("Blaster").appendField(new Blockly.FieldTextInput("name"),"NAME"),this.appendValueInput("FILE").setCheck("String").setAlign(Blockly.ALIGN_RIGHT).appendField("csv file:"),this.appendValueInput("RAMP_RATE").setCheck("Array").setAlign(Blockly.ALIGN_RIGHT).appendField("Rate ramp (/sec)"),this.appendValueInput("STEP_DURATION").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT).appendField("Step Duration (sec)"),this.appendValueInput("CLIENTS").setAlign(Blockly.ALIGN_RIGHT).setCheck("Number").appendField("Number of clients"),this.appendDummyInput(),this.appendDummyInput().appendField("Dequeue Callback: "),this.appendStatementInput("DEQUEUE_CALLBACK").setCheck(null),this.appendDummyInput().appendField("Progress Callback: "),this.appendStatementInput("PROGRESS_CALLBACK").setCheck(null),this.appendDummyInput().appendField("Blast Callback: "),this.appendStatementInput("BLAST_CALLBACK").setCheck(null),this.setColour(230),this.setTooltip(""),this.setHelpUrl("")}},Blockly.Blocks.flow={init:function(){this.appendDummyInput().appendField("Name:").appendField(new Blockly.FieldTextInput("do_flow"),"NAME"),this.appendStatementInput("Data").appendField("Data:").setCheck("Data"),this.appendStatementInput("Reaction").appendField("Reactions:").setCheck("Reaction"),this.appendDummyInput().appendField("Success Callback: "),this.appendStatementInput("SUCCESS_CALLBACK").setCheck(null),this.appendDummyInput().appendField("Fail Callback: "),this.appendStatementInput("FAIL_CALLBACK").setCheck(null),this.setColour(240),this.setTooltip(""),this.setHelpUrl("")}},Blockly.Blocks.flow_data={init:function(){this.appendValueInput("FILE").setCheck(null).appendField("smash_data_add_file"),this.setPreviousStatement(!0,"Data"),this.setNextStatement(!0,"Data"),this.setColour(230),this.setTooltip(""),this.setHelpUrl("")}},Blockly.Blocks.predefined_procedures={init:function(){this.setColour(230),this.itemCount_=1,this.setInputsInline(!0),this.appendDummyInput().appendField(new Blockly.FieldTextInput("Function_name"),"NAME"),this.updateShape_(),this.setOutput(!0),this.setMutator(new Blockly.Mutator(["predefined_procedures_with_params"]))},mutationToDom:function(){var e=document.createElement("mutation");return e.setAttribute("args",this.itemCount_),e},domToMutation:function(e){this.itemCount_=parseInt(e.getAttribute("args"),10),this.updateShape_()},decompose:function(e){var t=e.newBlock("predefined_procedures_with_container");t.initSvg();for(var n=t.getInput("STACK").connection,o=0;o<this.itemCount_;o++){var l=e.newBlock("predefined_procedures_with_params");l.initSvg(),n.connect(l.previousConnection),n=l.nextConnection}return t},compose:function(e){for(var t=e.getInputTargetBlock("STACK"),n=[];t;)n.push(t.valueConnection_),t=t.nextConnection&&t.nextConnection.targetBlock();for(var o=0;o<this.itemCount_;o++){var l=this.getInput("ARG"+o).connection.targetConnection;l&&n.indexOf(l)==-1&&l.disconnect()}this.itemCount_=n.length,this.updateShape_();for(var o=0;o<this.itemCount_;o++)Blockly.Mutator.reconnect(n[o],this,"ARG"+o)},saveConnections:function(e){for(var t=e.getInputTargetBlock("STACK"),n=0;t;){var o=this.getInput("ARG"+n);t.valueConnection_=o&&o.connection.targetConnection,n++,t=t.nextConnection&&t.nextConnection.targetBlock()}},updateShape_:function(){this.itemCount_&&this.getInput("EMPTY")&&this.removeInput("EMPTY");for(var e=0;e<this.itemCount_;e++)if(!this.getInput("ARG"+e)){this.appendValueInput("ARG"+e)}for(;this.getInput("ARG"+e);)this.removeInput("ARG"+e),e++}},Blockly.Blocks.predefined_procedures_noreturn={init:function(){this.setColour(230),this.itemCount_=1,this.setInputsInline(!0),this.appendDummyInput().appendField(new Blockly.FieldTextInput("Function_name"),"NAME"),this.updateShape_(),this.setOutput(!1),this.setMutator(new Blockly.Mutator(["predefined_procedures_with_params"])),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null)},mutationToDom:Blockly.Blocks.predefined_procedures.mutationToDom,domToMutation:Blockly.Blocks.predefined_procedures.domToMutation,decompose:Blockly.Blocks.predefined_procedures.decompose,compose:Blockly.Blocks.predefined_procedures.compose,saveConnections:Blockly.Blocks.predefined_procedures.saveConnections,updateShape_:Blockly.Blocks.predefined_procedures.updateShape_},Blockly.Blocks.predefined_procedures_with_container={init:function(){this.setColour(230),this.appendDummyInput().appendField("Inputs"),this.appendStatementInput("STACK"),this.contextMenu=!1}},Blockly.Blocks.predefined_procedures_with_params={init:function(){this.setColour(230),this.appendDummyInput().appendField("Input"),this.setPreviousStatement(!0),this.setNextStatement(!0),this.contextMenu=!1}},Blockly.Blocks.reaction_add={init:function(){this.appendValueInput("FILE").setCheck(null).appendField("webui_add_reaction_file").appendField("File:"),this.appendValueInput("GOAL").setAlign(Blockly.ALIGN_RIGHT).setCheck(null).appendField("GOAL:"),this.setPreviousStatement(!0,"Reaction"),this.setNextStatement(!0,"Reaction"),this.setColour(230),this.setTooltip(""),this.setHelpUrl("")}},Blockly.Blocks.reaction_remove={init:function(){this.appendValueInput("FILE").setCheck(null).appendField("webui_remove_reaction").appendField("File:"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(240),this.setTooltip(""),this.setHelpUrl("")}},Blockly.Blocks.reaction_do={init:function(){this.appendValueInput("FILE").setCheck(null).appendField("webui_do_reaction_file").appendField("File:"),this.setPreviousStatement(!0,null),this.setNextStatement(!0,null),this.setColour(240),this.setTooltip(""),this.setHelpUrl("")}},Blockly.Blocks.reaction_json={init:function(){this.appendDummyInput().appendField("Name:").appendField(new Blockly.FieldTextInput("reaction_name"),"NAME"),this.appendValueInput("TRIGGER").appendField("Trigger:"),this.appendValueInput("SUCCESS").appendField("Success:"),this.appendStatementInput("ACTIONS").appendField("Actions:").setCheck("Reaction_Action"),this.setColour(240)}},Blockly.Blocks.reaction_action_json={init:function(){this.appendDummyInput().appendField("Action:").appendField(new Blockly.FieldTextInput("do_it"),"ACTION"),this.appendValueInput("ARGUMENTS").appendField("Arguments:"),this.setPreviousStatement(!0,"Reaction_Action"),this.setNextStatement(!0,"Reaction_Action"),this.setColour(240)}},Blockly.json=new Blockly.Generator("json"),Blockly.json.ORDER_ATOMIC=0,Blockly.json.ORDER_CLONE=1,Blockly.json.ORDER_NEW=1,Blockly.json.ORDER_MEMBER=2.1,Blockly.json.ORDER_FUNCTION_CALL=2.2,Blockly.json.ORDER_POWER=3,Blockly.json.ORDER_INCREMENT=4,Blockly.json.ORDER_DECREMENT=4,Blockly.json.ORDER_BITWISE_NOT=4,Blockly.json.ORDER_CAST=4,Blockly.json.ORDER_SUPPRESS_ERROR=4,Blockly.json.ORDER_INSTANCEOF=5,Blockly.json.ORDER_LOGICAL_NOT=6,Blockly.json.ORDER_UNARY_PLUS=7.1,Blockly.json.ORDER_UNARY_NEGATION=7.2,Blockly.json.ORDER_MULTIPLICATION=8.1,Blockly.json.ORDER_DIVISION=8.2,Blockly.json.ORDER_MODULUS=8.3,Blockly.json.ORDER_ADDITION=9.1,Blockly.json.ORDER_SUBTRACTION=9.2,Blockly.json.ORDER_STRING_CONCAT=9.3,Blockly.json.ORDER_BITWISE_SHIFT=10,Blockly.json.ORDER_RELATIONAL=11,Blockly.json.ORDER_EQUALITY=12,Blockly.json.ORDER_REFERENCE=13,Blockly.json.ORDER_BITWISE_AND=13,Blockly.json.ORDER_BITWISE_XOR=14,Blockly.json.ORDER_BITWISE_OR=15,Blockly.json.ORDER_LOGICAL_AND=16,Blockly.json.ORDER_LOGICAL_OR=17,Blockly.json.ORDER_IF_NULL=18,Blockly.json.ORDER_CONDITIONAL=19,Blockly.json.ORDER_ASSIGNMENT=20,Blockly.json.ORDER_LOGICAL_AND_WEAK=21,Blockly.json.ORDER_LOGICAL_XOR=22,Blockly.json.ORDER_LOGICAL_OR_WEAK=23,Blockly.json.ORDER_COMMA=24,Blockly.json.ORDER_NONE=99,Blockly.json.ORDER_OVERRIDES=[[Blockly.json.ORDER_MEMBER,Blockly.json.ORDER_FUNCTION_CALL],[Blockly.json.ORDER_MEMBER,Blockly.json.ORDER_MEMBER],[Blockly.json.ORDER_LOGICAL_NOT,Blockly.json.ORDER_LOGICAL_NOT],[Blockly.json.ORDER_MULTIPLICATION,Blockly.json.ORDER_MULTIPLICATION],[Blockly.json.ORDER_ADDITION,Blockly.json.ORDER_ADDITION],[Blockly.json.ORDER_LOGICAL_AND,Blockly.json.ORDER_LOGICAL_AND],[Blockly.json.ORDER_LOGICAL_OR,Blockly.json.ORDER_LOGICAL_OR]],Blockly.json.init=function(e){Blockly.json.definitions_=Object.create(null),Blockly.json.functionNames_=Object.create(null),Blockly.json.variableDB_?Blockly.json.variableDB_.reset():Blockly.json.variableDB_=new Blockly.Names(Blockly.json.RESERVED_WORDS_)},Blockly.json.finish=function(e){var t=[];for(var n in Blockly.json.definitions_)t.push(Blockly.json.definitions_[n]);return delete Blockly.json.definitions_,delete Blockly.json.functionNames_,Blockly.json.variableDB_.reset(),t.join("\n\n")+"\n\n\n"+e},Blockly.json.scrubNakedValue=function(e){return e+"\n"},Blockly.json.quote_=function(e){return'"'+(e=e.replace(/\\/g,"\\\\").replace(/\n/g,"\\\n").replace(/'/g,"\\'"))+'"'},Blockly.json.scrub_=function(e,t){var n="";if(!e.outputConnection||!e.outputConnection.targetConnection){var o=e.getCommentText();o=Blockly.utils.wrap(o,Blockly.json.COMMENT_WRAP-3),o&&(n+=Blockly.json.prefixLines(o,"// ")+"\n");for(var l=0;l<e.inputList.length;l++)if(e.inputList[l].type==Blockly.INPUT_VALUE){var s=e.inputList[l].connection.targetBlock();if(s){var o=Blockly.json.allNestedComments(s);o&&(n+=Blockly.json.prefixLines(o,"# "))}}}var i=e.nextConnection&&e.nextConnection.targetBlock();return n+t+Blockly.json.blockToCode(i)},Blockly.json.lists_create_with=function(e){for(var t=new Array(e.itemCount_),n=0;n<e.itemCount_;n++)t[n]=Blockly.json.valueToCode(e,"ADD"+n,Blockly.json.ORDER_COMMA)||"";var t="["+t.join(", ")+"]";return[t,Blockly.json.ORDER_ATOMIC]},Blockly.json.reaction_json=function(e){var t=e.getFieldValue("NAME"),n=Blockly.json.valueToCode(e,"TRIGGER",Blockly.json.ORDER_ATOMIC),o=Blockly.json.valueToCode(e,"SUCCESS",Blockly.json.ORDER_ATOMIC),l=Blockly.json.statementToCode(e,"ACTIONS");return l=""===l?[]:"["+l+"]",["{",'    "reactions": [',"     {",'        "name": "'+t+'",','        "trigger": '+n+",",'        "success": '+o+",",'        "actions": '+l,"     }","    ]","};"].join("\n")},Blockly.json.reaction_action_json=function(e){var t=e.getFieldValue("ACTION"),n=Blockly.json.valueToCode(e,"ARGUMENTS",Blockly.json.ORDER_ATOMIC),o=['"'+t+'"'];o=o.concat(n);var l="[\n"+o.join(",\n  ")+"\n]",s=e.previousConnection.targetBlock();return e.previousConnection.isConnected()&&s.type!=e.type&&(l="[\n"+l,e.nextConnection.isConnected()?l+=",":l+="\n]"),l},Blockly.json.text=function(e){return[Blockly.json.quote_(e.getFieldValue("TEXT")),Blockly.json.ORDER_ATOMIC]},Blockly.bash.blaster=function(e){var t=(e.getFieldValue("NAME"),Blockly.bash.valueToCode(e,"FILE",Blockly.bash.ORDER_ATOMIC)),n=Blockly.bash.valueToCode(e,"RAMP_RATE",Blockly.bash.ORDER_ATOMIC);n=n||[];var o=Blockly.bash.valueToCode(e,"STEP_DURATION",Blockly.bash.ORDER_ATOMIC),l=Blockly.bash.valueToCode(e,"CLIENTS",Blockly.bash.ORDER_ATOMIC),s=Blockly.bash.statementToCode(e,"DEQUEUE_CALLBACK"),i=Blockly.bash.statementToCode(e,"PROGRESS_CALLBACK"),a=Blockly.bash.statementToCode(e,"BLAST_CALLBACK"),c=["PORT=32000","CSVFILE="+t,"RAMP="+n.join(" "),"STEPDURATION="+o,"CLIENTS="+l,"SERVER=localhost","BASENAME=`basename $0`","sm_data_add_kv sessionname:$BASENAME",'sm_log INFO "${BASENAME} started"',"err_exit()"," {",'    sm_log ERROR "${BASENAME} has error on line $1"'," }","trap 'err_exit $LINENO' ERR","cleanup()"," {","    set -e",'    sm_log INFO "${BASENAME} done"'," }",'trap "cleanup" EXIT'],r=["#","# client","#","function blast-dq-cb()"," {","    REF=$1","    UDATA=$2",'    echo "blaster-dq-cb"',"    echo $# $*","    echo `sm_dataref_tostring $1`",'    echo ""',s,"  sleep 1","}"],u=["function start-client()"," {","     SEQ=$1","     sm_blaster_dq_open test $SERVER $PORT","     COUNT=0",'     trap "break" INT',"     while [ 1 ] ; do","     if [ $COUNT -eq 0 ] ; then",'        PAYLOAD="{stb_id:INJECTED}"','         RES=`sm_blaster_dq test 5 blast-dq-cb myudata-${SEQ} "${PAYLOAD}"`',' #       sm_blaster_dq test 5 blast-dq-cb myudata-${SEQ} "${PAYLOAD}"',"     else","         RES=`sm_blaster_dq test 5 blast-dq-cb myudata-${SEQ}`"," #       sm_blaster_dq test 5 blast-dq-cb myudata-${SEQ}","     fi","     COUNT=$((COUNT+1))","     done","     sm_blaster_dq_close test","     exit 0"," }","# start the client in forks that don't return","for i in `seq 1 $CLIENTS` ; do","     ( start-client $i & )","done"," # start the server"," #"," # server"," #","function kill-children-and-exit()"," {","     jobs -p |xargs kill","     exit 0"," }","trap kill-children-and-exit SIGINT"],p=["function blast-progress-cb()"," {","STEP=$1","SECSLEFTINSTEP=$2","TOTALSTEPS=$3","RATE=$4","TRIGGERED=$5","ERRORED=$6","ACTUAL_RATE=$7","PUDATA=$8",'echo "blast-progress-cb"',"echo $@",'echo ""',i," }"],_=["function blast-cb()"," {","REF=$1","UDATA=$2","PAYLOAD=`sm_dataref_tostring $1`",'[ "${PAYLOAD}" == "gimme" ] && return','echo "blast-cb"',"echo $# $*","echo $PAYLOAD",'echo ""',a," }"],d=["# this returns when done","sm_blaster_ramp_process $CSVFILE $PORT $STEPDURATION blast-cb udata blast-progress-cb pudata `echo $RAMP`"];return[c.join("\n")+"\n\n"+r.join("\n")+"\n\n"+u.join("\n")+"\n\n"+p.join("\n")+"\n\n"+_.join("\n")+"\n\n"+d.join("\n"),Blockly.bash.ORDER_FUNCTION_CALL]},Blockly.bash.flow=function(e){for(var t=e.getFieldValue("NAME"),n=Blockly.bash.statementToCode(e,"Data").trim(),o=Blockly.bash.statementToCode(e,"Reaction").trim(),l=Blockly.bash.statementToCode(e,"SUCCESS_CALLBACK"),s=Blockly.bash.statementToCode(e,"FAIL_CALLBACK"),i=["BASENAME=`basename $0`",'flow_name="'+t+'"',"sm_data_add_kv sessionname:$BASENAME","CONF=../Config","REACTIONS=../Reactions","\nerr_exit()","{",'  sm_log ERROR "${BASENAME} has error on line $1"',"}","\ntrap 'err_exit $LINENO' ERR","\nsm_random_kick","sm_data_dequote_specials 1"],a=["sm_webui_open "+t,"\ncleanup()","{","    set -e","    sm_webui_status "+t+" flow_callback mydata","    sm_webui_close "+t,'    sm_log INFO "${BASENAME} done"',"}",'\ntrap "cleanup" EXIT'],c=['echo "^C to stop"','trap "break" INT','trap "break ; err_exit $LINENO" ERR',"while [ 1 ] ; do","  sm_webui_process "+t+" 5 flow_callback mydata","done"],r=[],u=["UDATA","WU_NAME","EVENT","REACTION","REACTION_NAME","STEP","COUNT"],p=0;p<u.length;p++)Blockly.getMainWorkspace().createVariable(u[p]),r.push("  "+u[p]+"=$"+(p+1));var _=["  echo $@ >> steps.txt",'  if [ "${EVENT}" == "WEBUI_CB_STEP_FAIL" ] || [ "${EVENT}" == "WEBUI_CB_FAIL" ] ; then',"    echo $@ >> FAIL.txt","  fi"],d=['  if [ "${EVENT}" == "WEBUI_CB_SUCCESS" ] ; then',l,"  fi"],R=['  if [ "${EVENT}" == "WEBUI_CB_FAIL" ] ; then',s,"  fi"],E="function flow_callback { \n"+r.join("\n")+"\n\n"+_.join("\n")+"\n\n"+d.join("\n")+"\n\n"+R.join("\n")+"\n}\n\n";return[i.join("\n")+"\n\n# Add data \n"+n+"\n\n"+a.join("\n")+"\n\n# Add reactions \n"+o+"\n\n# Callback \n"+E+"\n\n"+c.join("\n")+"\n\n",Blockly.bash.ORDER_FUNCTION_CALL]},Blockly.bash.flow_data=function(e){return"sm_data_add_file ${CONF}/"+Blockly.bash.valueToCode(e,"FILE",Blockly.bash.ORDER_ATOMIC)+"\n"},Blockly.bash.predefined_procedures=function(e){for(var t=e.getFieldValue("NAME"),n=[],o=0;o<e.itemCount_;o++)n.push(Blockly.bash.valueToCode(e,"ARG"+o,Blockly.bash.ORDER_COMMA)||"");return["`"+t+" "+n.join(" ")+"`",Blockly.bash.ORDER_FUNCTION_CALL]},Blockly.bash.predefined_procedures_noreturn=function(e){for(var t=e.getFieldValue("NAME"),n=[],o=0;o<e.itemCount_;o++)n.push(Blockly.bash.valueToCode(e,"ARG"+o,Blockly.bash.ORDER_COMMA)||"");return t+" "+n.join(" ")+"\n"},Blockly.bash.reaction_add=function(e){return"sm_webui_add_reaction_file $flow_name ${REACTIONS}/"+Blockly.bash.valueToCode(e,"FILE",Blockly.bash.ORDER_ATOMIC)+" "+Blockly.bash.valueToCode(e,"GOAL",Blockly.bash.ORDER_ATOMIC)+"\n"},Blockly.bash.reaction_do=function(e){return"sm_webui_do_reaction_file $flow_name  ${REACTIONS}/"+Blockly.bash.valueToCode(e,"FILE",Blockly.bash.ORDER_ATOMIC)+" flow_callback mydata\n"},qBlockly.bash.reaction_remove=function(e){return"sm_webui_remove_reaction $flow_name "+Blockly.bash.valueToCode(e,"FILE",Blockly.bash.ORDER_ATOMIC)+"\n"};